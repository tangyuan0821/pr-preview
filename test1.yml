name: upstream-pr-preview

on:
  schedule:
    - cron: "0 * * * *"  
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'ä»…å¤„ç†æŒ‡å®šçš„ä¸Šæ¸¸PRç¼–å·ï¼ˆå¯é€‰ï¼‰'
        required: false
  # repository_dispatchï¼šç”±ä¸Šæ¸¸ä»“åº“çš„ workflow ä¸»åŠ¨è°ƒç”¨æœ¬ä»“åº“çš„ API è§¦å‘
  repository_dispatch:
    types:
      - upstream-pr-opened
      - upstream-pr-synchronize
      - upstream-pr-reopened

permissions:
  contents: write

concurrency:
  group: upstream-pr-preview
  cancel-in-progress: true

env:
  UPSTREAM_REPO: tjy-gitnub/win12
  PREVIEW_ROOT: site
  PREVIEW_TIMEZONE: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.collect.outputs.prs }}
    steps:
      - name: æ”¶é›†éœ€è¦å¤„ç†çš„PRåˆ—è¡¨ï¼ˆå¤§å·ï¼Œåªè¯»ï¼‰
        id: collect
        env:
          GH_TOKEN: ${{ secrets.UPSTREAM_READ_PAT }}
          INPUT_PR: ${{ github.event.client_payload.pr_number || github.event.inputs.pr_number || '' }}
        run: |
          set -euo pipefail
          if [ -n "$INPUT_PR" ]; then
            PRS="[$INPUT_PR]"
          else
            PRS=$(gh api "repos/${UPSTREAM_REPO}/pulls" --paginate --jq '[.[] | select(.state=="open" and .draft==false and .merged==false) | .number]')
          fi
          if [ -z "$PRS" ]; then
            PRS="[]"
          fi
          echo "prs=$PRS" >> "$GITHUB_OUTPUT"
          echo "Target PRs: $PRS"

  deploy:
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: write
    env:
      UPSTREAM_REPO: tjy-gitnub/win12
      PR_LIST: ${{ needs.prepare.outputs.prs }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ï¼ˆé»˜è®¤tokenï¼Œä»…ç”¨äºéƒ¨ç½²ï¼‰
        uses: actions/checkout@v4

      - name: æ‹‰å–å¹¶æ„å»ºé¢„è§ˆï¼ˆå¤§å·ï¼Œåªè¯»ï¼‰
        id: build
        env:
          GH_TOKEN: ${{ secrets.UPSTREAM_READ_PAT }}
          PREVIEW_ROOT: site
        run: |
          set -euo pipefail
          mkdir -p "$PREVIEW_ROOT"
          echo "$PR_LIST" | jq -e . > /tmp/prs.json
          : > /tmp/comment_info.jsonl
          : > /tmp/validate.list

          PR_COUNT=$(jq 'length' /tmp/prs.json)
          if [ "$PR_COUNT" -eq 0 ]; then
            echo "No open PRs found; will clean gh-pages."
            echo "æš‚æ— è¿›è¡Œä¸­çš„PR / No active PR previews" > "$PREVIEW_ROOT/README.md"
          fi

          for pr in $(jq -r '.[]' /tmp/prs.json); do
            if ! [[ "$pr" =~ ^[0-9]+$ ]]; then
              echo "Invalid PR number ${pr}, skipping (PRç¼–å·æ ¼å¼å¼‚å¸¸ï¼Œå·²è·³è¿‡)"
              continue
            fi
            data=$(gh api "repos/${UPSTREAM_REPO}/pulls/${pr}")
            state=$(echo "$data" | jq -r '.state')
            draft=$(echo "$data" | jq -r '.draft')
            merged=$(echo "$data" | jq -r '.merged')
            if [ "$state" != "open" ] || [ "$draft" = "true" ] || [ "$merged" = "true" ]; then
              echo "Skip #$pr (state=$state draft=$draft merged=$merged)"
              continue
            fi

            sha=$(echo "$data" | jq -r '.head.sha')
            head_repo=$(echo "$data" | jq -r '.head.repo.full_name')

            if [ -z "$head_repo" ] || [ "$head_repo" = "null" ]; then
              echo "Head repo missing for PR #$pr, skipping (æºä»“åº“ç¼ºå¤±ï¼Œå·²è·³è¿‡)"
              continue
            fi

            if ! printf '%s' "$head_repo" | grep -Eq '^[A-Za-z0-9._-]+/[A-Za-z0-9._-]+$'; then
              echo "Unexpected head repo format for PR #$pr, skipping (æºä»“åº“æ ¼å¼å¼‚å¸¸ï¼Œå·²è·³è¿‡)"
              continue
            fi

            archive="pr-${pr}.zip"
            curl -L --fail --max-filesize 104857600 \
              -H "Authorization: Bearer $GH_TOKEN" \
              -o "$archive" \
              "https://api.github.com/repos/${head_repo}/zipball/${sha}"
            unzip -q "$archive" -d "/tmp/src-$pr"
            SRC_DIRS=$(find "/tmp/src-$pr" -maxdepth 1 -type d -not -path "/tmp/src-$pr" || true)
            SRC_DIR=$(printf "%s\n" "$SRC_DIRS" | head -n 1)
            if [ -z "$SRC_DIR" ]; then
              echo "Unable to locate extracted source directory for PR #$pr, skipping (è§£å‹ç›®å½•ç¼ºå¤±ï¼Œå·²è·³è¿‡)"
              continue
            fi
            SRC_COUNT=$(printf "%s\n" "$SRC_DIRS" | grep -c . || true)
            if [ "${SRC_COUNT:-0}" -ne 1 ]; then
              echo "Unexpected archive layout for PR #$pr, skipping (è§£å‹ç›®å½•æ•°é‡å¼‚å¸¸ï¼Œå·²è·³è¿‡)"
              continue
            fi
            rsync -a --delete "${SRC_DIR}/" "$PREVIEW_ROOT/pr-${pr}/"
            target_html="$PREVIEW_ROOT/pr-${pr}/desktop.html"
            if [ -f "$target_html" ]; then
              banner='<div id="pr-preview-disclaimer" style="position:fixed;top:0;left:0;right:0;z-index:2147483647;padding:12px 44px 12px 16px;background:#d92d20;color:#fff;font:700 14px/1.4 -apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,sans-serif;box-shadow:0 2px 12px rgba(0,0,0,.25);">æœ¬é¢„è§ˆç¯å¢ƒæºè‡ª Pull Requestï¼Œç”¨äºéªŒè¯éƒ¨ç½²æ•ˆæœã€‚å®Œæ•´ä½“éªŒè¯·è®¿é—® Win12 ç¨³å®šç‰ˆæœ¬ã€‚ / Preview from a Pull Request for deployment validation. Visit the stable version of Win12 for the full experience.<button type="button" aria-label="å…³é—­ Close" onclick="this.parentElement.remove()" style="position:absolute;top:8px;right:10px;border:0;background:transparent;color:#fff;font-size:22px;line-height:1;cursor:pointer;">Ã—</button></div>'
              if ! grep -q 'id="pr-preview-disclaimer"' "$target_html"; then
                if grep -qi '</body>' "$target_html"; then
                  BANNER="$banner" perl -0pi -e 's#</body>#$ENV{BANNER}</body>#i' "$target_html"
                elif grep -qi '</html>' "$target_html"; then
                  BANNER="$banner" perl -0pi -e 's#</html>#$ENV{BANNER}</html>#i' "$target_html"
                else
                  printf '\n%s\n' "$banner" >> "$target_html"
                fi
              fi
            fi
            echo "$pr $sha" >> /tmp/validate.list
          done

          if [ -s /tmp/validate.list ]; then
            pushd "$PREVIEW_ROOT" >/dev/null
            python3 -m http.server 8000 >"/tmp/http-server.log" 2>&1 &
            SERVER_PID=$!
            trap "kill $SERVER_PID 2>/dev/null" EXIT
            sleep 2
            while read -r pr sha; do
              if curl -fsS "http://localhost:8000/pr-${pr}/desktop.html" >/dev/null; then
                printf '{"number":%s,"sha":"%s"}\n' "$pr" "$sha" >> /tmp/comment_info.jsonl
              else
                echo "desktop.html validation failed for PR #$pr, skipping comment and deployment (desktop.html æ ¡éªŒå¤±è´¥ï¼Œå·²è·³è¿‡)" >&2
                tail -n 50 "/tmp/http-server.log" || true
                rm -rf "${PREVIEW_ROOT}/pr-${pr}"
              fi
            done < /tmp/validate.list
            trap - EXIT
            kill "$SERVER_PID" 2>/dev/null || true
            popd >/dev/null
          fi

      - name: éƒ¨ç½²åˆ° GitHub Pagesï¼ˆé»˜è®¤tokenï¼‰
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: site
          publish_branch: gh-pages
          commit_message: "chore: update PR previews"

      - name: å‘å¸ƒ/æ›´æ–°é¢„è§ˆè¯„è®ºï¼ˆå°å·ï¼Œä»…PRå†™æƒé™ï¼‰
        if: success() && github.event_name != 'schedule'
        env:
          GH_TOKEN: ${{ secrets.PREVIEW_COMMENT_PAT }}
          BOT_USERNAME: ${{ secrets.PREVIEW_COMMENT_USERNAME }}
          UPSTREAM_REPO: tjy-gitnub/win12
          PREVIEW_ROOT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          MARKER="PR é¢„è§ˆ"
          if [ ! -s /tmp/comment_info.jsonl ]; then
            echo "No successful builds; skip commenting."
            exit 0
          fi
          if [ -n "${BOT_USERNAME:-}" ]; then
            bot_login="$BOT_USERNAME"
          else
            bot_login=$(gh api user --jq .login) || { echo "Failed to resolve bot login from token (æ— æ³•é€šè¿‡ä»¤ç‰Œè§£ææœºå™¨äººè´¦å·)"; exit 1; }
          fi

          while IFS= read -r line; do
            pr=$(echo "$line" | jq -r '.number')
            sha=$(echo "$line" | jq -r '.sha')
            url="${PREVIEW_ROOT_URL}/pr-${pr}/desktop.html"
            deployed_at=$(env TZ="${PREVIEW_TIMEZONE}" date "+%Y-%m-%d %H:%M:%S %Z")

            body=$(printf '**%s**\n\n| é¡¹ç›® | è¯¦æƒ… |\n|------|------|\n| é¢„è§ˆé“¾æ¥ | %s |\n| æäº¤å“ˆå¸Œ | `%s` |\n| éƒ¨ç½²æ—¶é—´ï¼ˆ%sï¼‰ | %s |\n\n> [!TIP]\n> ğŸ’¡ è‹¥ PR ç»§ç»­æäº¤ï¼Œæ–°é¢„è§ˆå°†è‡ªåŠ¨è¦†ç›–å¹¶æ›´æ–°æœ¬è¯„è®ºã€‚\n> å¦‚æ‚¨å‘ç°é—®é¢˜ï¼Œæ¬¢è¿é€šè¿‡[issues](https://github.com/tangyuan0821/win12-pr-preview/issues)æäº¤åé¦ˆã€‚\n' "$MARKER" "$url" "$sha" "$PREVIEW_TIMEZONE" "$deployed_at")
            existing=$(gh api "repos/${UPSTREAM_REPO}/issues/${pr}/comments" --jq 'map(select(.user.login==$bot and (.body | contains($marker)))) | sort_by(.updated_at) | last | .id' --arg bot "$bot_login" --arg marker "$MARKER" || true)
            if [ -n "$existing" ] && [ "$existing" != "null" ]; then
              gh api "repos/${UPSTREAM_REPO}/issues/comments/${existing}" -X PATCH -f body="$body"
            else
              gh api "repos/${UPSTREAM_REPO}/issues/${pr}/comments" -X POST -f body="$body"
            fi
          done < /tmp/comment_info.jsonl